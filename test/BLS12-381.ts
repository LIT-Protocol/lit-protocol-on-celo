import { expect } from 'chai';
import { ethers } from 'hardhat';
import { LitVerify } from '../typechain/LitVerify';

describe('BLS12-381', function () {
  let bls: LitVerify;
  before(async () => {
    const BLS = await ethers.getContractFactory('LitVerify');
    bls = await BLS.deploy();
  });

  it('expand_message_xmd', async function () {
    const msg =
      '0x65794a68624763694f694a4354464d784d69307a4f4445694c434a30655841694f694a4b5631516966512e65794a7063334d694f694a4d535651694c434a6a6147467062694936496d5630614756795a5856744969776961574630496a6f784e6a4d354d4459314e6a59344c434a6c654841694f6a45324d7a6b784d4467344e6a6773496d4e68624778535a5846315a584e3063794936573373695a6e4a7662534936496a42345a6a686d4e7a67334d3259344d44417a4f5751314f5463344d3255334d4455355a574e6d5a6a56684e6d4d304f5751334d4751304e794973496e5276496a6f694d4867315a6a526c597a4e6b5a6a6c6a596d51304d7a63784e475a6c4d6a63304d4759315a544d324d5459784e54566a4e5749344e444535496977695a47463059534936496a42345a6d56685a6a6b324f474d6966563073496d4e68624778535a584e776232357a5a584d694f6c73694d4867774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4455774d4441774d4441774d4441774d44417a597a59304d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774e6a4669595445335a6d5269597a41774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774e6a46694d6a49325a5745774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d445978596a49794e6d56684d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441314d4441774d4441774d4441774d4441774d324d324e434a646651';
    expect(await bls.expand_message_xmd(msg)).equal(
      '0x40d43074ee846df712118ceb49286776d7880e3744e4e4ea0f94338d94993b70ffbea2b402261e55845ca54188952c4e890f3a06e920c4f07c4e0951549c4e9b397215ba4cee78dc1b85597d804e77f08bb803d8545f6255f69db4ea1fcd0dad4a3cbbac6f504cae29751b43b23052917d2b5f74ac979e083224e0b9c8b182d502bb2df18acdcca1719be3bf91683ff8b3acf22180440e58145f3d29358e856f78b10a4f94fe32423b10523db66b0e75ce3d256845aab769a0104cf1cf247b8ad9d43dbc44151a63d498daf16e4d5bfab56c5a2a80f75f9e8db1d0aeadd01eaa74c4fbb4a60fc74414f68fa196af1357a567f9e4017bc26a8ddba70878ee210b'
    );
  });

  it('hash_to_field', async function () {
    const msg =
      '0x65794a68624763694f694a4354464d784d69307a4f4445694c434a30655841694f694a4b5631516966512e65794a7063334d694f694a4d535651694c434a6a6147467062694936496d5630614756795a5856744969776961574630496a6f784e6a4d354d4459314e6a59344c434a6c654841694f6a45324d7a6b784d4467344e6a6773496d4e68624778535a5846315a584e3063794936573373695a6e4a7662534936496a42345a6a686d4e7a67334d3259344d44417a4f5751314f5463344d3255334d4455355a574e6d5a6a56684e6d4d304f5751334d4751304e794973496e5276496a6f694d4867315a6a526c597a4e6b5a6a6c6a596d51304d7a63784e475a6c4d6a63304d4759315a544d324d5459784e54566a4e5749344e444535496977695a47463059534936496a42345a6d56685a6a6b324f474d6966563073496d4e68624778535a584e776232357a5a584d694f6c73694d4867774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4455774d4441774d4441774d4441774d44417a597a59304d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774e6a4669595445335a6d5269597a41774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774e6a46694d6a49325a5745774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d445978596a49794e6d56684d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441314d4441774d4441774d4441774d4441774d324d324e434a646651';
    const fps = await bls.hash_to_field(msg);
    const rs = [
      '0x0000000000000000000000000000000003004d4b574513e821288e73e24004c62abd074634961d6f067e36519cb030a7462adb99285ef10c99f5b9ecb44f901b0000000000000000000000000000000017de5ca33b6b96e5f23bc17ee16de9d61d0acaf25d7076875638d6f8df9b413b9578e4520e88dc12a576c6954e25a999',
      '0x00000000000000000000000000000000153532e4bafcef3de3ef2c990357d69f7221977e8d5c8ca62f90a73f128b4f1b1d551853c8cd79b4ebc5137db48ed908000000000000000000000000000000000390245a884c3cea6eae2bbc1844f840f63b51f01c361a7ff4de661ab23c4683026800bac1d728dd621eb831aa7c490b',
    ];
    expect(fps[0]).equal(rs[0]);
    expect(fps[1]).equal(rs[1]);
  });

  it('hash_to_curve', async function () {
    const msg =
      '0x65794a68624763694f694a4354464d784d69307a4f4445694c434a30655841694f694a4b5631516966512e65794a7063334d694f694a4d535651694c434a6a6147467062694936496d5630614756795a5856744969776961574630496a6f784e6a4d354d4459314e6a59344c434a6c654841694f6a45324d7a6b784d4467344e6a6773496d4e68624778535a5846315a584e3063794936573373695a6e4a7662534936496a42345a6a686d4e7a67334d3259344d44417a4f5751314f5463344d3255334d4455355a574e6d5a6a56684e6d4d304f5751334d4751304e794973496e5276496a6f694d4867315a6a526c597a4e6b5a6a6c6a596d51304d7a63784e475a6c4d6a63304d4759315a544d324d5459784e54566a4e5749344e444535496977695a47463059534936496a42345a6d56685a6a6b324f474d6966563073496d4e68624778535a584e776232357a5a584d694f6c73694d4867774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4455774d4441774d4441774d4441774d44417a597a59304d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774e6a4669595445335a6d5269597a41774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774e6a46694d6a49325a5745774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d445978596a49794e6d56684d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441314d4441774d4441774d4441774d4441774d324d324e434a646651';

    expect(await bls.hash_to_curve(msg)).equal(
      '0x000000000000000000000000000000000c54644ffb122ee24d1c095f8b7707139252226c3841b136a28dda4ee0f6d21f5ec933d4003452fc6b8f7564e09a65550000000000000000000000000000000006810151bdf1aa1c3aa743bd85d142984b4a23ee99a77d98dab3e73d17b4272f70f043ff5c81f1506729def59ead50b20000000000000000000000000000000012122ea7178c6b0ea8b54a5d3929be64861430cc9fc6174e64e48cbdb04946afa39cb95375cf0918e3e5b7243977874e0000000000000000000000000000000004f9b54cf0ce78498c1d79b8f7d816d042cd0e3be991fba4c40bb1990543d7790cff219bf048dc97a09ca5ee8ac0dda5'
    );
  });

  it('exp', async function () {
    expect(
      await bls.callBigModExp(
        '0x40d43074ee846df712118ceb49286776d7880e3744e4e4ea0f94338d94993b70ffbea2b402261e55845ca54188952c4e890f3a06e920c4f07c4e0951549c4e9b',
        '0x000000000000000000000000000000001a0111ea397fe69a4b1ba7b6434bacd764774b84f38512bf6730d2a0f6b0f6241eabfffeb153ffffb9feffffffffaaab'
      )
    ).equal(
      '0x0000000000000000000000000000000003004d4b574513e821288e73e24004c62abd074634961d6f067e36519cb030a7462adb99285ef10c99f5b9ecb44f901b'
    );
  });

  it('verify', async function () {
    /* toHex(
       base64(JSON.stringify({ "alg": "BLS12-381", "typ": "JWT" }))
        + '.'
         + base64(JSON.stringify({ "iss": "LIT", "chain": "ethereum", "iat": 1639065668, "exp": 1639108868, "callRequests": [{ "from": "0xf8f7873f80039d59783e7059ecff5a6c49d70d47", "to": "0x5f4ec3df9cbd43714fe2740f5e3616155c5b8419", "data": "0xfeaf968c" }], "callResponses": ["0x0000000000000000000000000000000000000000000000050000000000003c6400000000000000000000000000000000000000000000000000000061ba17fdbc0000000000000000000000000000000000000000000000000000000061b226ea0000000000000000000000000000000000000000000000000000000061b226ea0000000000000000000000000000000000000000000000050000000000003c64"] }))
      )
    */
    const msg =
      '0x65794a68624763694f694a4354464d784d69307a4f4445694c434a30655841694f694a4b5631516966512e65794a7063334d694f694a4d535651694c434a6a6147467062694936496d5630614756795a5856744969776961574630496a6f784e6a4d354d4459314e6a59344c434a6c654841694f6a45324d7a6b784d4467344e6a6773496d4e68624778535a5846315a584e3063794936573373695a6e4a7662534936496a42345a6a686d4e7a67334d3259344d44417a4f5751314f5463344d3255334d4455355a574e6d5a6a56684e6d4d304f5751334d4751304e794973496e5276496a6f694d4867315a6a526c597a4e6b5a6a6c6a596d51304d7a63784e475a6c4d6a63304d4759315a544d324d5459784e54566a4e5749344e444535496977695a47463059534936496a42345a6d56685a6a6b324f474d6966563073496d4e68624778535a584e776232357a5a584d694f6c73694d4867774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4455774d4441774d4441774d4441774d44417a597a59304d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774e6a4669595445335a6d5269597a41774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774e6a46694d6a49325a5745774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d445978596a49794e6d56684d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441314d4441774d4441774d4441774d4441774d324d324e434a646651';
    // G2.fromSignature(original sig)
    // It's easy and safe to compute in client compare with within contract
    const sig =
      '0x000000000000000000000000000000000e52a3df96d706defb5f9ee1fa2fa2c8c303d98ddaa1b1b48075c10f73ef0581a350436a2961f18a4e1c5c18a0fb677c00000000000000000000000000000000102307e80a81561db51bcb56441a3de926dbcb8e8a0ec80048280fb09390ed7ca140f3b6111360e11a4fa2e1295557310000000000000000000000000000000019fa0a1cc3d9dcafcb1ea664d60ca60f120450b35d4d2898db2c63e318e2c70205a62f3716e5ee1e2dc190a1da1d1249000000000000000000000000000000001325a6d30c9c43f4dfc4227c7dc06ec09582b60283fe8ac72e723282744cac79d76eb1ca33c542844727cdc2fbe7119f';

    expect(await bls.verify(msg, sig)).equal(true);
  });
});
